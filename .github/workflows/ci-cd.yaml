name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: write
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  EKS_CLUSTER_NAME: "demo"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # Set AWS credentials at job level
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run tests
        run: mvn test

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: Update Kubernetes manifest
        if: github.event_name != 'pull_request'
        run: |
          sed -i "s|image:.*|image: ghcr.io/${{ github.repository }}:${{ github.sha }}|g" k8s/deployment.yaml
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add k8s/deployment.yaml
          git commit -m "Update image to ${{ github.sha }}" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Configure kubectl for EKS
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ”§ Configuring kubectl for EKS cluster: ${{ env.EKS_CLUSTER_NAME }}"
          aws eks update-kubeconfig \
            --name ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}
          
          echo "âœ… kubectl configured"
          kubectl version --client

      - name: Check if ArgoCD is installed
        if: github.event_name != 'pull_request'
        id: argocd-check
        run: |
          echo "ğŸ” Checking if ArgoCD is installed..."
          
          if kubectl get namespace argocd &> /dev/null; then
            echo "âœ… ArgoCD namespace found"
            
            if kubectl get crd applications.argoproj.io &> /dev/null; then
              echo "âœ… ArgoCD Application CRD found"
              echo "installed=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  ArgoCD CRDs not found"
              echo "installed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸  ArgoCD namespace not found"
            echo "installed=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply ArgoCD Application
        if: github.event_name != 'pull_request' && steps.argocd-check.outputs.installed == 'true'
        run: |
          echo "ğŸ“¦ Applying ArgoCD Application to cluster..."
          kubectl apply -f argocd/application.yaml
          
          echo ""
          echo "âœ… ArgoCD Application registered!"
          echo "ğŸ” Check status:"
          echo "   kubectl get application testapp-v6 -n argocd"
          
          echo ""
          echo "ğŸš€ ArgoCD will now automatically sync from:"
          echo "   Repository: ${{ github.repository }}"
          echo "   Path: k8s/"
          echo "   Image: ghcr.io/${{ github.repository }}:${{ github.sha }}"

      - name: ArgoCD not installed - Manual steps required
        if: github.event_name != 'pull_request' && steps.argocd-check.outputs.installed != 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  ArgoCD is not installed on the EKS cluster"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "To enable GitOps deployment, install ArgoCD first:"
          echo ""
          echo "1ï¸âƒ£ Install ArgoCD:"
          echo "   kubectl create namespace argocd"
          echo "   kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml"
          echo ""
          echo "2ï¸âƒ£ Wait for ArgoCD to be ready:"
          echo "   kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s"
          echo ""
          echo "3ï¸âƒ£ Apply the ArgoCD Application:"
          echo "   kubectl apply -f argocd/application.yaml"
          echo ""
          echo "4ï¸âƒ£ Access ArgoCD UI:"
          echo "   kubectl port-forward svc/argocd-server -n argocd 8080:443"
          echo "   # Get initial admin password:"
          echo "   kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "â„¹ï¸  For now, the Docker image has been built and pushed to GHCR."
          echo "   You can still deploy manually using:"
          echo "   kubectl apply -f k8s/"
          echo ""
